<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="9.8 Cleaning and tidying | Insights from Data" />
<meta property="og:type" content="book" />


<meta property="og:description" content="To be completed" />


<meta name="author" content="Owen Petchey, Andrew Beckerman, Natalie Cooper, Dylan Childs" />

<meta name="date" content="2020-01-02" />


<meta name="description" content="To be completed">

<title>9.8 Cleaning and tidying | Insights from Data</title>

<script src="libs/jquery/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap/js/bootstrap.min.js"></script>
<script src="libs/bootstrap/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap/shim/respond.min.js"></script>
<script src="libs/navigation/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/toc.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#introduction"><span class="toc-section-number">1</span> Introduction</a><ul>
<li><a href="1-1-introduction-1.html#introduction-1"><span class="toc-section-number">1.1</span> Introduction</a></li>
<li><a href="1-2-workflowchecklist.html#workflowchecklist"><span class="toc-section-number">1.2</span> Workflow/checklist</a></li>
<li><a href="1-3-r-project-setup.html#r-project-setup"><span class="toc-section-number">1.3</span> R-project setup</a></li>
<li class="has-sub"><a href="1-4-for-instructors.html#for-instructors"><span class="toc-section-number">1.4</span> For instructors</a><ul>
<li><a href="1-4-for-instructors.html#live-data-demo"><span class="toc-section-number">1.4.1</span> Live data analysis demonstration</a></li>
</ul></li>
<li><a href="1-5-datasets.html#datasets"><span class="toc-section-number">1.5</span> Datasets</a></li>
<li class="has-sub"><a href="1-6-more-case-studies.html#more-case-studies"><span class="toc-section-number">1.6</span> More case studies</a><ul>
<li><a href="1-6-more-case-studies.html#hungry-ladybirds"><span class="toc-section-number">1.6.1</span> Hungry ladybirds</a></li>
<li><a href="1-6-more-case-studies.html#seal-suppers"><span class="toc-section-number">1.6.2</span> Seal suppers</a></li>
<li><a href="1-6-more-case-studies.html#more-bat-poop"><span class="toc-section-number">1.6.3</span> More bat poop</a></li>
<li><a href="1-6-more-case-studies.html#marten-isotopes"><span class="toc-section-number">1.6.4</span> Marten isotopes</a></li>
<li><a href="1-6-more-case-studies.html#snake-diets"><span class="toc-section-number">1.6.5</span> Snake diets</a></li>
<li><a href="1-6-more-case-studies.html#desert-bat-diets"><span class="toc-section-number">1.6.6</span> Desert bat diets</a></li>
<li><a href="1-6-more-case-studies.html#desert-bat-diets-1"><span class="toc-section-number">1.6.7</span> Desert bat diets</a></li>
<li><a href="1-6-more-case-studies.html#birds-eating-insects"><span class="toc-section-number">1.6.8</span> Birds eating insects</a></li>
<li><a href="1-6-more-case-studies.html#diets-of-predatory-fish"><span class="toc-section-number">1.6.9</span> Diets of predatory fish</a></li>
<li><a href="1-6-more-case-studies.html#cervical-spine-compression-and-mri-not-food-related"><span class="toc-section-number">1.6.10</span> Cervical spine compression and MRI (not food related)</a></li>
<li><a href="1-6-more-case-studies.html#lots-of-other-datasets-here"><span class="toc-section-number">1.6.11</span> Lots of other datasets here:</a></li>
</ul></li>
<li><a href="1-7-related-books.html#related-books"><span class="toc-section-number">1.7</span> Related reading</a></li>
</ul></li>
<li><a href="2-insights-workflow.html#insights-workflow"><span class="toc-section-number">2</span> Insights Workflow</a></li>
<li><a href="3-before-touching-rrstudio.html#before-touching-rrstudio"><span class="toc-section-number">3</span> Before touching R/RStudio</a></li>
<li><a href="4-after-we-read-the-datafiles-into-r.html#after-we-read-the-datafiles-into-r"><span class="toc-section-number">4</span> After we read the datafile(s) into R:</a></li>
<li><a href="5-after-data-tidying-and-cleaning.html#after-data-tidying-and-cleaning"><span class="toc-section-number">5</span> After data tidying and cleaning</a></li>
<li><a href="6-additional-r.html#additional-r"><span class="toc-section-number">6</span> Additional R</a></li>
<li><a href="7-additional-concepts.html#additional-concepts"><span class="toc-section-number">7</span> Additional concepts</a></li>
<li class="has-sub"><a href="8-WFD-2.html#WFD-2"><span class="toc-section-number">8</span> Are diets more diverse in more democratic countries?</a><ul>
<li><a href="8-1-about-this-case-study.html#about-this-case-study"><span class="toc-section-number">8.1</span> About this case study</a></li>
<li><a href="8-2-introduction-to-the-study-and-data.html#introduction-to-the-study-and-data"><span class="toc-section-number">8.2</span> Introduction to the study and data</a></li>
<li><a href="8-3-a-little-preparation.html#a-little-preparation"><span class="toc-section-number">8.3</span> A little preparation</a></li>
<li class="has-sub"><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#polity-data-origins-acquire-import-clean-tidy-nas-duplicates"><span class="toc-section-number">8.4</span> Polity data: origins, acquire, import, clean, tidy, NAs, duplicates</a><ul>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#data-origins-and-acquisition"><span class="toc-section-number">8.4.1</span> Data origins and acquisition</a></li>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#data-import"><span class="toc-section-number">8.4.2</span> Data import</a></li>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#tidy-and-clean"><span class="toc-section-number">8.4.3</span> Tidy and clean</a></li>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#deal-with-nas"><span class="toc-section-number">8.4.4</span> Deal with NAs</a></li>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#deal-with-innapropriate-duplicates"><span class="toc-section-number">8.4.5</span> Deal with innapropriate duplicates</a></li>
<li><a href="8-4-polity-data-origins-acquire-import-clean-tidy-nas-duplicates.html#check-ranges-of-numeric-variables"><span class="toc-section-number">8.4.6</span> Check ranges of numeric variables</a></li>
</ul></li>
<li><a href="8-5-first-insights-from-the-polity-data.html#first-insights-from-the-polity-data"><span class="toc-section-number">8.5</span> First insights from the polity data</a></li>
<li class="has-sub"><a href="8-6-acquire-import-check-the-fao-food-balance-sheet-data.html#acquire-import-check-the-fao-food-balance-sheet-data"><span class="toc-section-number">8.6</span> Acquire, import, check the FAO Food balance sheet data</a><ul>
<li><a href="8-6-acquire-import-check-the-fao-food-balance-sheet-data.html#tidying-FAO"><span class="toc-section-number">8.6.1</span> Tidy the FAO data</a></li>
<li><a href="8-6-acquire-import-check-the-fao-food-balance-sheet-data.html#clean-the-fao-data"><span class="toc-section-number">8.6.2</span> Clean the FAO data</a></li>
<li><a href="8-6-acquire-import-check-the-fao-food-balance-sheet-data.html#calculating-our-response-variables"><span class="toc-section-number">8.6.3</span> Calculating our response variables</a></li>
</ul></li>
<li><a href="8-7-merge-the-two-datasets.html#merge-the-two-datasets"><span class="toc-section-number">8.7</span> Merge the two datasets</a></li>
<li><a href="8-8-tidying-up.html#tidying-up"><span class="toc-section-number">8.8</span> Tidying up</a></li>
<li><a href="8-9-shapes.html#shapes"><span class="toc-section-number">8.9</span> Shapes</a></li>
<li><a href="8-10-relationships.html#relationships"><span class="toc-section-number">8.10</span> Relationships</a></li>
<li><a href="8-11-wrapping-up.html#wrapping-up"><span class="toc-section-number">8.11</span> Wrapping up</a></li>
<li><a href="8-12-some-questions.html#some-questions"><span class="toc-section-number">8.12</span> Some questions</a></li>
</ul></li>
<li class="has-sub"><a href="9-WFD-3.html#WFD-3"><span class="toc-section-number">9</span> Are more diverse diets better?</a><ul>
<li><a href="9-1-going-to-the-next-level.html#going-to-the-next-level"><span class="toc-section-number">9.1</span> Going to the next level</a></li>
<li><a href="9-2-introduction-to-the-study-and-data-1.html#introduction-to-the-study-and-data-1"><span class="toc-section-number">9.2</span> Introduction to the study and data</a></li>
<li><a href="9-3-what-type-of-response-variable.html#what-type-of-response-variable"><span class="toc-section-number">9.3</span> What type of response variable?</a></li>
<li><a href="9-4-a-little-preparation-1.html#a-little-preparation-1"><span class="toc-section-number">9.4</span> A little preparation</a></li>
<li><a href="9-5-acquire-the-dataset.html#acquire-the-dataset"><span class="toc-section-number">9.5</span> Acquire the dataset</a></li>
<li><a href="9-6-import-the-dataset.html#import-the-dataset"><span class="toc-section-number">9.6</span> Import the dataset</a></li>
<li><a href="9-7-checking-the-import-worked-correctly.html#checking-the-import-worked-correctly"><span class="toc-section-number">9.7</span> Checking the import worked correctly</a></li>
<li class="has-sub"><a href="9-8-cleaning-and-tidying.html#cleaning-and-tidying"><span class="toc-section-number">9.8</span> Cleaning and tidying</a><ul>
<li><a href="9-8-cleaning-and-tidying.html#recode-some-names"><span class="toc-section-number">9.8.1</span> Recode some names</a></li>
<li><a href="9-8-cleaning-and-tidying.html#make-the-prey_composition-variable-a-factor-with-specific-order"><span class="toc-section-number">9.8.2</span> Make the <code>prey_composition</code> variable a factor with specific order</a></li>
<li><a href="9-8-cleaning-and-tidying.html#fix-those-variable-names"><span class="toc-section-number">9.8.3</span> Fix those variable names</a></li>
<li><a href="9-8-cleaning-and-tidying.html#calculate-an-important-variable"><span class="toc-section-number">9.8.4</span> Calculate an important variable</a></li>
<li><a href="9-8-cleaning-and-tidying.html#remove-nas"><span class="toc-section-number">9.8.5</span> Remove NAs</a></li>
<li><a href="9-8-cleaning-and-tidying.html#checking-some-specifics"><span class="toc-section-number">9.8.6</span> Checking some specifics</a></li>
<li><a href="9-8-cleaning-and-tidying.html#a-closer-look-at-the-data"><span class="toc-section-number">9.8.7</span> A closer look at the data</a></li>
<li><a href="9-8-cleaning-and-tidying.html#calculate-the-three-response-variables"><span class="toc-section-number">9.8.8</span> Calculate the three response variables</a></li>
</ul></li>
<li><a href="9-9-shapes-1.html#shapes-1"><span class="toc-section-number">9.9</span> Shapes</a></li>
<li class="has-sub"><a href="9-10-relationships-1.html#relationships-1"><span class="toc-section-number">9.10</span> Relationships</a><ul>
<li><a href="9-10-relationships-1.html#maximum-predator-density"><span class="toc-section-number">9.10.1</span> Maximum predator density</a></li>
<li><a href="9-10-relationships-1.html#predator-population-variability-cv"><span class="toc-section-number">9.10.2</span> Predator population variability (CV)</a></li>
<li><a href="9-10-relationships-1.html#predator-persistence-time"><span class="toc-section-number">9.10.3</span> Predator persistence time</a></li>
<li><a href="9-10-relationships-1.html#all-three-at-once"><span class="toc-section-number">9.10.4</span> All three at once</a></li>
</ul></li>
<li><a href="9-11-wrapping-up-1.html#wrapping-up-1"><span class="toc-section-number">9.11</span> Wrapping up</a></li>
<li><a href="9-12-some-questions-1.html#some-questions-1"><span class="toc-section-number">9.12</span> Some questions</a></li>
</ul></li>
<li class="has-sub"><a href="10-WFD-4.html#WFD-4"><span class="toc-section-number">10</span> Effects of dietary restriction</a><ul>
<li><a href="10-1-before-working-in-r.html#before-working-in-r"><span class="toc-section-number">10.1</span> Before working in R</a></li>
<li class="has-sub"><a href="10-2-after-importing-the-data-into-r.html#after-importing-the-data-into-r"><span class="toc-section-number">10.2</span> After importing the data into R</a><ul>
<li><a href="10-2-after-importing-the-data-into-r.html#checking-for-duplicates"><span class="toc-section-number">10.2.1</span> Checking for duplicates</a></li>
<li><a href="10-2-after-importing-the-data-into-r.html#nas-variable-entries-e.g.levels-of-characters-ranges-of-numerics-numbers-of-things"><span class="toc-section-number">10.2.2</span> NAs, variable entries, e.g. levels of characters, ranges of numerics, numbers of “things”*</a></li>
</ul></li>
<li><a href="10-3-independence.html#independence"><span class="toc-section-number">10.3</span> Independence</a></li>
<li><a href="10-4-balance-in-experimental-design.html#balance-in-experimental-design"><span class="toc-section-number">10.4</span> Balance in experimental design</a></li>
<li class="has-sub"><a href="10-5-calculate-response-variables-if-required.html#calculate-response-variables-if-required"><span class="toc-section-number">10.5</span> Calculate response variable(s) (if required)</a><ul>
<li><a href="10-5-calculate-response-variables-if-required.html#time-of-death"><span class="toc-section-number">10.5.1</span> Time of death</a></li>
<li><a href="10-5-calculate-response-variables-if-required.html#change-in-length"><span class="toc-section-number">10.5.2</span> Change in length</a></li>
<li><a href="10-5-calculate-response-variables-if-required.html#change-in-condition"><span class="toc-section-number">10.5.3</span> Change in condition</a></li>
</ul></li>
<li><a href="10-6-merge-all-datasets-together-and-check-for-correct-number-of-rows.html#merge-all-datasets-together-and-check-for-correct-number-of-rows"><span class="toc-section-number">10.6</span> Merge all datasets together and check for correct number of rows</a></li>
<li><a href="10-7-super-sleuth-questions.html#super-sleuth-questions"><span class="toc-section-number">10.7</span> Super sleuth questions</a></li>
<li><a href="10-8-inspect-shapes-distributions.html#inspect-shapes-distributions"><span class="toc-section-number">10.8</span> Inspect shapes (distributions)</a></li>
<li><a href="10-9-inspect-relationships.html#inspect-relationships"><span class="toc-section-number">10.9</span> Inspect relationships</a></li>
<li><a href="10-10-moatt-et-al-data-s1-mortality-data.html#moatt-et-al-data-s1-mortality-data"><span class="toc-section-number">10.10</span> Moatt et al Data S1 – Mortality Data</a></li>
<li><a href="10-11-moatt-et-al-data-s5-courtship-data.html#moatt-et-al-data-s5-courtship-data"><span class="toc-section-number">10.11</span> Moatt et al Data S5 – Courtship Data</a></li>
<li><a href="10-12-moatt-et-al-data-s6-eggs-data.html#moatt-et-al-data-s6-eggs-data"><span class="toc-section-number">10.12</span> Moatt et al Data S6 – Eggs Data</a></li>
<li><a href="10-13-moatt-et-al-data-s15-length-weight-and-condition-index-data.html#moatt-et-al-data-s15-length-weight-and-condition-index-data"><span class="toc-section-number">10.13</span> Moatt et al Data S15 – Length, Weight and Condition Index Data</a></li>
</ul></li>
<li><a href="11-summing-up.html#summing-up"><span class="toc-section-number">11</span> Summing up</a></li>
<li><a href="references.html#references">References</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="cleaning-and-tidying" class="section level2">
<h2><span class="header-section-number">9.8</span> Cleaning and tidying</h2>
<div id="recode-some-names" class="section level3">
<h3><span class="header-section-number">9.8.1</span> Recode some names</h3>
<p>We expect the <code>species</code> and the <code>prey.composition</code> variables should probably be character variables. Indeed, they really should be characters, but they appear to be integers. Always use the proper word when you have one —don’t ever use codes like this (the person who entered this data was probably not thinking about this carefully enough! Or was constrained by time. Or both.). Let’s fix this by replacing the species code numbers with their names (we found the correct names for each code in the lab book for this experiment, it is not in the dataset):</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">mutate</span>(dd, <span class="dt">species =</span> <span class="kw">recode</span>(species,
                                <span class="st">&quot;1&quot;</span> =<span class="st"> &quot;Colpidium&quot;</span>,
                                <span class="st">&quot;2&quot;</span> =<span class="st"> &quot;Collodictyon&quot;</span>,
                                <span class="st">&quot;3&quot;</span> =<span class="st"> &quot;Paramecium&quot;</span>,
                                <span class="st">&quot;4&quot;</span> =<span class="st"> &quot;Dileptus&quot;</span>))</code></pre>
<p>Here we do a <code>mutate</code> to make a new version of the <code>species</code> variable, and the <code>recode</code> function to change the numbers to the species names. We first give <code>recode</code> the variable to work on (<code>species</code>) and then tell it to change each 1 to “Colpidium” and so on for the other numbers.</p>
<p>Next we work on the <code>prey.composition</code> variable. In fact, we’re just going to throw it away as it is redundant, because we can construct it from the species variable. Let’s do that. While we’re at it, let’s also get the prey richness from the other columns, rather than use the existing imported <code>prey.richness</code> column.</p>
<p>The first thing we’ll do is make a new dataset containing these two new variables, <code>community_composition</code> and <code>prey_richness</code>, and we’ll get these variables for each prey composition and replicate combination:</p>
<pre class="sourceCode r"><code class="sourceCode r">comm_comp &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey.composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">community_composition =</span> <span class="kw">paste</span>(<span class="kw">unique</span>(species), <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>),
            <span class="dt">prey_richness =</span> <span class="kw">length</span>(<span class="kw">unique</span>(species)) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</code></pre>
<p>Let’s break this down. We’re doing a <code>group_by</code>—<code>summarise</code>. The <code>group_by</code> is by <code>prey.composition</code> (seven compositions) and <code>replicate</code> (five replicates), so we’re expecting 7 * 5 = 35 rows in this new dataset. Then in the <code>summarise</code> we create in the first line the new <code>community_composition</code> variable, and in the second the new <code>prey_richness</code> variable. To make the new <code>community_composition</code> variable we paste together the species present in the group (composition by replicate combination); we use <code>unique</code> to remove repeats of the species names, and <code>collapse</code> to make the species names in a group be pasted together into one string. Take a look at the new <code>community_composition</code> variable, and then look again at the code above and the description of how we just made this new <code>prey_composition</code> variable.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">select</span>(comm_comp, community_composition)</code></pre>
<pre><code>## Adding missing grouping variables: `prey.composition`</code></pre>
<pre><code>## # A tibble: 35 x 2
## # Groups:   prey.composition [7]
##   prey.composition community_composition
##              &lt;dbl&gt; &lt;chr&gt;                
## 1                1 Colpidium, Dileptus  
## 2                1 Colpidium, Dileptus  
## 3                1 Colpidium, Dileptus  
## 4                1 Colpidium, Dileptus  
## 5                1 Colpidium, Dileptus  
## # … with 30 more rows</code></pre>
<p>We also make the new <code>prey_richness</code> variable. The code was <code>prey_richness = length(unique(species)) - 1</code>. The <code>length</code> function tells us the number of unique (because we used the <code>unique</code> function) species, and we subtract the 1 to remove the 1 added by the predator species being present.</p>
<p>Next we do more or less the same thing to get a new variable <code>prey_composition</code>. This will be the same as the community composition variable we just made, but without the predator species name included. The code is more or less the same, but with the predator (<em>Dileptus</em>) rows filtered out before the <code>summarise</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">prey_comp &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey.composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(species <span class="op">!=</span><span class="st"> &quot;Dileptus&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prey_composition =</span> <span class="kw">paste</span>(<span class="kw">unique</span>(species), <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>))</code></pre>
<p>The final thing to do is to add the new variables to the original dataset. We do this by merging (joining) the datasets with the new variables into the original dataset, one then the other, then we clean a bit by removing the old <code>prey.composition</code> and <code>prey.richness</code> variables, and by removing the <code>comm_comp</code> and <code>prey_comp</code> datasets which were only of temporary use.</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">full_join</span>(dd, comm_comp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(prey_comp) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>prey.composition, <span class="op">-</span>prey.richness)</code></pre>
<pre><code>## Joining, by = c(&quot;prey.composition&quot;, &quot;replicate&quot;)
## Joining, by = c(&quot;prey.composition&quot;, &quot;replicate&quot;)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(comm_comp, prey_comp)</code></pre>
<div class="safety">
<p>
It’s not necessary to remove variables that we’re not interested in using anymore, but is often a good idea to do so. It can prevent us accidentally using them, or just from getting confused about what they are and if they are in fact important when we come back to our work after a gap of a few months, as often happens. If we have a rather large dataset, keeping only the essential variables can usefully reduce the size of the dataset.
</p>
</div>
</div>
<div id="make-the-prey_composition-variable-a-factor-with-specific-order" class="section level3">
<h3><span class="header-section-number">9.8.2</span> Make the <code>prey_composition</code> variable a factor with specific order</h3>
<p>What on earth did that mean? So far we have not mentioned <em>factors</em>. These are a type of variable that contains words (a bit like character variables) but in which the different words/categories are referred to as <em>levels</em> and have an explicit order. This order affects how some things are done in R, and this is why we want to determine the specific order of the levels of the <code>prey_composition</code> variable. For example, when we make a graph with <code>prey_composition</code> on the x axis we would like the three single-species prey compositions first on the left, then the three two-species prey compositions, then the three-species prey composition on the right.</p>
<p>Before we do this, look at the <code>prey_composition</code> variable in its current state:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">select</span>(dd, prey_composition)</code></pre>
<pre><code>## # A tibble: 806 x 1
##   prey_composition
##   &lt;chr&gt;           
## 1 Colpidium       
## 2 Colpidium       
## 3 Colpidium       
## 4 Colpidium       
## 5 Collodictyon    
## # … with 801 more rows</code></pre>
<p>It is a character variable (<code>&lt;chr&gt;</code>). If we try to see what the levels of this variable are, we get <code>NULL</code>; there are no levels:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">levels</span>(<span class="kw">pull</span>(dd, prey_composition))</code></pre>
<pre><code>## NULL</code></pre>
<p>To change this to an ordered factor type variable, we use the <code>fct_relevel</code> function from the <strong>forcats</strong> package inside a <code>mutate</code> change the <code>prey_composition</code> variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">mutate</span>(dd,
             <span class="dt">prey_composition =</span> <span class="kw">fct_relevel</span>(prey_composition,
                                            <span class="st">&quot;Collodictyon&quot;</span>,
                                            <span class="st">&quot;Colpidium&quot;</span>,
                                            <span class="st">&quot;Paramecium&quot;</span>,
                                            <span class="st">&quot;Colpidium, Collodictyon&quot;</span>,
                                            <span class="st">&quot;Colpidium, Paramecium&quot;</span>,
                                            <span class="st">&quot;Collodictyon, Paramecium&quot;</span>,
                                            <span class="st">&quot;Colpidium, Collodictyon, Paramecium&quot;</span>)
                                            )</code></pre>
<p>Now let’s see how the <code>prey_composition</code> variable looks:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">select</span>(dd, prey_composition)</code></pre>
<pre><code>## # A tibble: 806 x 1
##   prey_composition
##   &lt;fct&gt;           
## 1 Colpidium       
## 2 Colpidium       
## 3 Colpidium       
## 4 Colpidium       
## 5 Collodictyon    
## # … with 801 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">levels</span>(<span class="kw">pull</span>(dd, prey_composition))</code></pre>
<pre><code>## [1] &quot;Collodictyon&quot;                       
## [2] &quot;Colpidium&quot;                          
## [3] &quot;Paramecium&quot;                         
## [4] &quot;Colpidium, Collodictyon&quot;            
## [5] &quot;Colpidium, Paramecium&quot;              
## [6] &quot;Collodictyon, Paramecium&quot;           
## [7] &quot;Colpidium, Collodictyon, Paramecium&quot;</code></pre>
<p>Excellent. The variable is now a factor (<code>&lt;fct&gt;</code>) and we can see its levels.</p>
<div class="info">
<p>
Do not worry if it’s not immediately apparent why we made this variable an ordered factor—we emphasise the point a couple of times below where the benefits of this are very clear and obviously desirable.
</p>
</div>
</div>
<div id="fix-those-variable-names" class="section level3">
<h3><span class="header-section-number">9.8.3</span> Fix those variable names</h3>
<p>We don’t have any spaces, brackets, or other special characters in variable names, and there is no date variable we need to correctly format. Great – the person who entered the data did something right!</p>
</div>
<div id="calculate-an-important-variable" class="section level3">
<h3><span class="header-section-number">9.8.4</span> Calculate an important variable</h3>
<p>When we first introduced the data, we identified four variables that would be used to calculate the number of individual organisms <em>per ml</em>. We must do this because different volumes and dilutions of liquid were counted at different times in the experiment. Standardising the abundance measures to number of individuals per ml will also allow interoperability with data from other studies that have also been standardised.</p>
<p>Look at the definitions of the four variables <code>count</code>, <code>w1</code>, <code>w2</code>, and <code>w3</code> and see if you can figure out how to convert the count to per ml. It’s not easy, but not too difficult perhaps. Really, give it a go. The challenge of getting insights from data is in large part about being able to solve problems like these. After solving them on paper we can then move to R to implement the solution.</p>
<p>Start by simplifying the problem. Imagine we made no dilution of <code>w1</code> such that <code>w2 = w1</code> and counted all of <code>w1</code> such that <code>w3 = w1</code>. In effect we just took the volume <code>w1</code> from the experimental culture and counted the number of individuals in it. If <code>w1</code> is 1 ml, then then the number of individuals counted (in variable <code>count</code>) is per ml. If <code>w1</code> is 0.5ml, we need to multiple the count by 2 (i.e. divide by 0.5) to get to per ml. If <code>w1</code> is 2 ml we need to divide by 2 to get to per ml. In this case we could use the formula <code>count / w1</code> to convert to number of individuals per ml.</p>
<p>Now think about if we sampled 1 ml (<code>w1</code> = 1 ml), added 1 ml of diluent (<code>w2</code> = 2 ml), and then counted 1 ml of that diluted sample (<code>w3</code> = 1). We have diluted by a factor of 2 (<code>w2 / w1</code> = 2) and counted 1 ml of that dilution, so we need to multiply the count by 2 to get to per ml. That is, we multiply the count by the dilution factor to get the count per ml (so long as <code>w3</code> = 1 ml).</p>
<p>Finally, think about if we count only 0.1 ml of the diluted sample (<code>w3</code> = 0.1 ml). That is a tenth of a ml, so we need to multiply by ten (or divide by 0.1). That is, we divide by <code>w3</code> to correct to count per ml when <code>w3</code> is not 1 ml.</p>
<p>Putting these parts together we see that we multiply by the dilution factor <code>w2/w1</code> and then divide by the volume counted (<code>w3</code>). We, of course, add the new <code>dens_per_ml</code> variable and calculation using the <code>mutate</code> function:</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">mutate</span>(dd, <span class="dt">dens_per_ml=</span>count<span class="op">*</span>w2<span class="op">/</span>w1<span class="op">/</span>w3)</code></pre>
<p>Super-simple! Now we have a standardised, comparable, and interoperable measurement of population size of each species.</p>
<div class="efficiency">
<p>
Actually, the dataset as it was entered was done so to make this calculation work very easily. In particular, <code>w2</code> is very purposefully the sum of the sampled volume and the diluent, and is <em>not</em> just the volume of the diluent. Furthermore, if there was no dilution, and the count was made of <code>w1</code> we might have entered <code>NA</code> for <code>w2</code> and <code>w3</code> since they did not exist. Instead, the both <code>w2</code> and <code>w3</code> are set to 1 in this case, which means they have no effect in the calculation (multiplication and division by 1 has no effect). This is an example of designing and planning before and during data entry with downstream calculations in mind. (The researcher responsible for the dataset can’t take credit for this very useful forethought—he received great advice from a colleague!)
</p>
</div>
</div>
<div id="remove-nas" class="section level3">
<h3><span class="header-section-number">9.8.5</span> Remove NAs</h3>
<p>When we imported the data we noticed some values of <code>count</code> were missing (<code>NA</code>). The reason these particular counts are NA while there are still values of <code>w1</code>, <code>w2</code>, and <code>w3</code> is a bit of a puzzle. One might imagine that the <code>NA</code> should really be a zero. In fact, what the researcher did was to sometimes enter <code>NA</code> after a species had become apparently extinct, because after not seeing individuals of a species for several days there was no attempt to observe that species, even though a sample was taken to observe any other still extant species in that community. So these <code>NA</code> values are when a species has gone extinct, and so could be zero, but since no count was attempted, it was appropriate to enter missing value <code>NA</code>. A consequence of all that is that we can remove all observations/rows containing an <code>NA</code>.</p>
<p>We can do this with a <code>filter</code> so that we remove only rows with an <code>NA</code> in the <code>count</code> variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">temp1 &lt;-<span class="st"> </span><span class="kw">filter</span>(dd, <span class="op">!</span><span class="kw">is.na</span>(count))
<span class="kw">nrow</span>(temp1)</code></pre>
<pre><code>## [1] 680</code></pre>
<p>Or remove we can remove rows with and <code>NA</code> in any of the variables:</p>
<pre class="sourceCode r"><code class="sourceCode r">temp2 &lt;-<span class="st"> </span><span class="kw">na.omit</span>(dd)
<span class="kw">nrow</span>(temp2)</code></pre>
<pre><code>## [1] 680</code></pre>
<p>Since the number of remaining rows is the same for both approaches we know there we no observations in which a variable other than <code>count</code> contained an <code>NA</code> when the <code>count</code> variable did not. So we’re safe doing it either way. Let’s overwrite <code>dd</code> with a new version with no <code>NA</code> values.</p>
<pre class="sourceCode r"><code class="sourceCode r">dd &lt;-<span class="st"> </span><span class="kw">na.omit</span>(dd)</code></pre>
</div>
<div id="checking-some-specifics" class="section level3">
<h3><span class="header-section-number">9.8.6</span> Checking some specifics</h3>
<p>We should check some feature of the dataset specific to the study.</p>
<p>Which days were samples taken on? To find this we <code>pull</code> the <code>day</code> variable from the tibble <code>dd</code> and get its <code>unique</code> values:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unique</span>(<span class="kw">pull</span>(dd, day))</code></pre>
<pre><code>##  [1]  2  4  6  8 10 12 14 16 18 20</code></pre>
<p>Samples were taken every two days from day to until a maximum of day 20. So we expect a maximum number of counts of species abundances in a particular replicate to be 10 multiplied by the number of species in a replicate community. I.e. the maximum number of counts in a community with two prey species and the predator (recall that all communities contained the predator) will be 30. Maximum number of counts will be 20 for communities with only one prey species. Note that this is the maximum because we know some values of count were <code>NA</code>.</p>
<p>Let’s now get the number of counts for each replicate community, and while we’re at it, the last day sampled for each replicate. We do this with a <code>group_by %&gt;% summarise</code> pipeline, grouping by the <code>jar</code> and <code>prey_composition</code> variables. We include the <code>prey_composition</code> variable in the grouping so that we have it to refer to in the resulting summary dataset, and place it first in the <code>group_by</code> function so that the summary dataset is arranged by this variable.</p>
<pre class="sourceCode r"><code class="sourceCode r">temp1 &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_composition, jar) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">num_samples =</span> <span class="kw">n</span>(),
            <span class="dt">max_day =</span> <span class="kw">max</span>(day))
temp1</code></pre>
<pre><code>## # A tibble: 35 x 4
## # Groups:   prey_composition [7]
##   prey_composition   jar num_samples max_day
##   &lt;fct&gt;            &lt;dbl&gt;       &lt;int&gt;   &lt;dbl&gt;
## 1 Collodictyon         3          11      12
## 2 Collodictyon         4          11      12
## 3 Collodictyon        18          14      14
## 4 Collodictyon        19          14      14
## 5 Collodictyon        20           4       4
## # … with 30 more rows</code></pre>
<div class="info">
<p>
Notice how the dataset is arranged in the same order as the levels of the <code>prey_composition</code> variable that we specified when we made this variable an ordered factor type variable. The order is as we planned. If we had not made the <code>prey_composition</code> variable into an ordered factor, R would have chosen its preferred arrangement/ordering, and often this is not our preference. You can see R’s preferred arrangement if you replace <code>prey_composition</code> with <code>as.character(prey_composition)</code> in the <code>group_by</code>.
</p>
</div>
<p>Looking at the summary tibble <code>temp1</code> (remember you can use <code>View(temp1)</code> or click on <code>temp1</code> in the <em>Environment</em> tab) we see that each of the prey compositions has five replicates, exactly as expected. And, also as expected, the maximum number of samples is 10 times the number of species, though often this maximum was not realised. We also see that some communities were sampled for longer than others (we assume this is due to sampling ceasing when all species went extinct).</p>
<p>We can have R confirm the number of replicates per prey composition with a quick <code>group_by %&gt;% summarise</code> pipeline working on <code>temp1</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">temp1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(prey_composition) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">number_of_replicate =</span> <span class="kw">n</span>())</code></pre>
<pre><code>## # A tibble: 7 x 2
##   prey_composition        number_of_replicate
##   &lt;fct&gt;                                 &lt;int&gt;
## 1 Collodictyon                              5
## 2 Colpidium                                 5
## 3 Paramecium                                5
## 4 Colpidium, Collodictyon                   5
## 5 Colpidium, Paramecium                     5
## # … with 2 more rows</code></pre>
<p>We can also get the number of counts made of each species by using the same code with <code>species</code> added as a grouping variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">temp2 &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_composition, jar, species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">num_samples =</span> <span class="kw">n</span>(),
            <span class="dt">max_day =</span> <span class="kw">max</span>(day))
temp2</code></pre>
<pre><code>## # A tibble: 95 x 5
## # Groups:   prey_composition, jar [35]
##   prey_composition   jar species    num_samples max_day
##   &lt;fct&gt;            &lt;dbl&gt; &lt;chr&gt;            &lt;int&gt;   &lt;dbl&gt;
## 1 Collodictyon         3 Collodict…           5      10
## 2 Collodictyon         3 Dileptus             6      12
## 3 Collodictyon         4 Collodict…           5      10
## 4 Collodictyon         4 Dileptus             6      12
## 5 Collodictyon        18 Collodict…           7      14
## # … with 90 more rows</code></pre>
<p>Here we see that two of the microcosms had only two samples taken. These are the ones in which the last day sampled was day four (confirm this for yourself if you wish; <code>View(temp2)</code> is useful for this).</p>
<div class="safety">
<p>
All this might seem like overkill, particularly if we imagine that we had collected and entered the data into the spreadsheet. Surely then we would know all this, and therefore not have to check it? It’s not overkill, however. It’s about making efforts to ensure that we and R are in perfect agreement about the nature and contents of the data. Reaching such agreement is absolutely essential, and often involves resolving differences of opinion by highlighting hidden (and potentially dangerous) assumptions made by us and/or by R about the nature and contents of the data. By taking such efforts we are investing in the foundations of our insights. We need solid foundations for reliable, robust, and accurate insights.
</p>
</div>
</div>
<div id="a-closer-look-at-the-data" class="section level3">
<h3><span class="header-section-number">9.8.7</span> A closer look at the data</h3>
<p>We so far have not looked at the species abundances and have not yet calculated the three required response variables. Let’s begin by looking at the species abundances, and do this by plotting the dynamics of the species in each microcosm. Now you will begin to see the power, elegance, and amazingness of <code>ggplot</code>. We will map the log 10 transformed abundance data onto the y-axis. We will map the <code>day</code> variable onto the x-axis. We will plot the data as points and lines (so use <code>geom_line</code> and <code>geom_point</code>) and we will map the <code>species</code> variable onto the colour of the points and lines. And we will make a grid of facets using <code>facet_grid</code> with rows of the grid corresponding to prey composition and columns for the replicates. Translating that into <code>ggplot</code> terms we get the following code (producing Figure <a href="9-8-cleaning-and-tidying.html#fig:microbe1">9.1</a>):</p>
<pre class="sourceCode r"><code class="sourceCode r">dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> day, <span class="dt">y =</span> <span class="kw">log10</span>(dens_per_ml), <span class="dt">col =</span> species)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_grid</span>(prey_composition <span class="op">~</span><span class="st"> </span>replicate)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:microbe1"></span>
<img src="insights_website_files/figure-html/microbe1-1.png" alt="Population dynamics observed during the experiment." width="100%" />
<p class="caption">
FIGURE 9.1: Population dynamics observed during the experiment.
</p>
</div>
<div class="info">
<p>
Notice the order of the rows—it is from top to bottom the order we specified when we made the <code>prey_composition</code> variable an ordered factor. So <code>ggplot</code> is using this order. If you like to see what the order would have been if we hadn’t specified it, replace <code>prey_composition</code> with <code>as.character(prey_composition)</code>.
</p>
</div>
<p>The dynamics in Figure <a href="9-8-cleaning-and-tidying.html#fig:microbe1">9.1</a> are those shown in figure 1 of the original publication. Everything seems reasonable, though I (Owen) wish I’d recorded more information about why I stopped sampling the microcosms when I did. I think I still have my lab books from this experiment somewhere inaccessible like my parents loft but haven’t had the chance to get them.</p>
<p>The predator (<em>Dileptus</em>) does not seem to grow well when <em>Collodictyon</em> is the only available prey species, but grows very well on and decimates <em>Colpidium</em>, after which the predator appears to go extinct and then the <em>Colpidium</em> population recovers. We can also notice that the predator population persists to the end of the experiment on day 20 only when all three prey species are present. It is probably worth emphasising that 20 days corresponds to around 20 generations of these organisms; this is a lot of time for birth and death to affect population abundances (if each individual divided into two daughters each day, the population would increase in size by a factor of 2^20, i.e. grow to be 1 million times larger).</p>
<p>We could again use the <code>skim()</code> function to take a look at the data more closely.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">skim</span>(dd)</code></pre>
<pre><code>## Skim summary statistics
##  n obs: 680 
##  n variables: 12 
## 
## ── Variable type:character ───────────────────────
##               variable missing complete   n min max
##  community_composition       0      680 680  19  45
##                species       0      680 680   8  12
##  empty n_unique
##      0        7
##      0        4
## 
## ── Variable type:factor ──────────────────────────
##          variable missing complete   n n_unique
##  prey_composition       0      680 680        7
##                             top_counts ordered
##  Col: 161, Col: 108, Col: 105, Col: 98   FALSE
## 
## ── Variable type:numeric ─────────────────────────
##       variable missing complete   n   mean      sd
##          count       0      680 680  17.05   27.13
##            day       0      680 680   8.79    5   
##    dens_per_ml       0      680 680 500.2  1880.55
##            jar       0      680 680  20.73   10.2 
##  prey_richness       0      680 680   1.93    0.73
##      replicate       0      680 680   3.21    1.41
##             w1       0      680 680   0.61    0.78
##             w2       0      680 680   1.67    2.48
##             w3       0      680 680   0.8     0.33
##     p0   p25   p50    p75     p100     hist
##  0      0     5     22      200    ▇▁▁▁▁▁▁▁
##  2      4     8     12       20    ▇▃▃▃▃▂▁▂
##  0      0    16.41 270.27 26609.54 ▇▁▁▁▁▁▁▁
##  1     12    22     30       35    ▃▃▃▅▂▅▅▇
##  1      1     2      2        3    ▆▁▁▇▁▁▁▅
##  1      2     3      4        5    ▆▆▁▇▁▇▁▇
##  0.018  0.3   0.4    0.81    12.22 ▇▁▁▁▁▁▁▁
##  1      1     1      1.96    59.24 ▇▁▁▁▁▁▁▁
##  0.084  0.38  1      1        2.14 ▂▁▁▇▁▁▁▁</code></pre>
</div>
<div id="calculate-the-three-response-variables" class="section level3">
<h3><span class="header-section-number">9.8.8</span> Calculate the three response variables</h3>
<p>There are three response variables corresponding to the three hypotheses about why increased prey diversity might increase predator population stability:</p>
<ul>
<li>Predator population abundance.</li>
<li>Predator population variability.</li>
<li>Predator population persistence time.</li>
</ul>
<div id="calculating-predator-dileptus-abundance" class="section level4">
<h4><span class="header-section-number">9.8.8.1</span> Calculating predator (<em>Dileptus</em>) abundance</h4>
<p>You might be thinking “we already have predator abundance”, and you’d be correct. We have estimates of the number per ml on each of the sample days. The issue that we now have to deal with, and solve somehow, is that of independence of observations. When we take repeated measures of the same thing, here the same predator population in the same experimental community, the repeated measures are not independent, and measures closer together in time are less independent than are those further apart in time. There are some rather complex and perhaps sophisticated ways of accounting for the non-independence in repeated measures, but they are beyond the scope of what we want to cover. Instead we are going to use a rather crude, but also quite valid solution. That is to use the maximum predator abundance in each of the experimental unit (communities). There are 35 experimental communities, so we expect to have 35 estimates of average predator abundance.</p>
<p>To make the calculation in R we will use a <code>filter %&gt;% group_by %&gt;% summarise</code> pipeline. We filter to keep only the observations of the predator (<em>Dileptus</em>), then group the data by <code>prey_richness</code>, <code>prey_composition</code>, and <code>replicate</code>, then calculate two summary values. The first summary value, named by us <code>pred_max_dens</code> is the maximum density of the predator population observed in each experimental community. The second variable calculated, named by us <code>all_zero</code> is TRUE if all the predator densities were zero, or is otherwise FALSE. Here is the R code:</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_max_dens &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(species <span class="op">==</span><span class="st"> &quot;Dileptus&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_richness, prey_composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">max_dens =</span> <span class="kw">max</span>(dens_per_ml),
            <span class="dt">all_zero =</span> <span class="kw">sum</span>(dens_per_ml <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) </code></pre>
<p>As expected, the resulting tibble contains 35 observations and four variables. Lovely. We will look at the values after we calculate the other two response variables.</p>
<div class="info">
<p>
In the <code>group_by</code> we included a redundant grouping variable <code>prey_richness</code>. It is redundant in the sense that we would have got the same resulting tibble if we had not included it, the only difference being that the resulting tibble would not have contained the <code>prey_richness</code> variable. We will often find ourselves including redundant variables in a <code>group_by</code> because we would like to them to appear in the resulting tibble so we can use them later.
</p>
</div>
<div class="warning">
<p>
We calculated the maximum of the predator abundance, but could have chosen the mean, median, or the geometric mean, or harmonic mean. It is really important to recognise that the choice of mean here is quite arbitrary, and so introduces an element of subjectivity into our journey from data to insights. Such subjectivity is a rather common feature of this journey.
</p>
</div>
<div class="reliability">
<p>
We must make sure our insights are robust to subjective decisions about how to reach them. We can do this by looking at whether the insights are sensitive to changes in these decisions. This is quite different, however, from selecting the decision that gives a result we might desire, which would clearly be a totally inappropriate practice.
</p>
</div>
</div>
<div id="calculating-predator-dileptus-population-variability" class="section level4">
<h4><span class="header-section-number">9.8.8.2</span> Calculating predator (<em>Dileptus</em>) population variability</h4>
<p>We will use the coefficient of variation as the measure of predator population variable. The coefficient of variation, or CV for short, is the standard deviation of the abundances divided by the mean of the abundances. What values might we expect? Well, one thing to expect is some undefined values, since we know that in six of the communities there were no predators observed. The mean will therefore be zero, and the result of division by zero is undefined. So we expect the CV to be <code>NaN</code> for the six communities in which the predator was never observed.</p>
<p>The R code is very similar to that used in the previous section to calculate maximum predator abundance:</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_CV &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(species <span class="op">==</span><span class="st"> &quot;Dileptus&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_richness, prey_composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">CV =</span> <span class="kw">sd</span>(dens_per_ml) <span class="op">/</span><span class="st"> </span><span class="kw">mean</span>(dens_per_ml),
            <span class="dt">all_zero =</span> <span class="kw">sum</span>(dens_per_ml <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</code></pre>
<p>Looking at the data (e.g. with <code>View(pred_CV</code>) shows us that indeed there are six <code>NaN</code> values of CV. We will look at the other CV values after we calculate the third response variable.</p>
<div class="efficiency">
<p>
<strong>Congratulations</strong> if you noticed that we could have calculated maximum abundance and CV of abundance in the same summarise. This would have been more efficient, in the sense that we would have had less code. It would also have been safer since then we could not have accidentally done something different (e.g. a different grouping) for the two.
</p>
</div>
</div>
<div id="calculating-predator-dileptus-persistence-time" class="section level4">
<h4><span class="header-section-number">9.8.8.3</span> Calculating predator (<em>Dileptus</em>) persistence time</h4>
<p>Before we do, what type of variable is this? One characteristic is that it is “time to event” data… we are observing the amount of time taken for a particular event (here extinction) to occur. The values can’t be negative. They could be continuous, but in this case are not, because we sampled only every other day. Hence the variable is discrete numbers. We will go into a bit more detail about this nature of values of persistence time after we calculate them.</p>
<p>We get the last day on which <em>Dileptus</em> was observed with a <code>filter %&gt;% group_by %&gt;% summarise</code> pipeline. We filter to retain only observations of <em>Dileptus</em> being present (i.e. we exclude observations when <em>Dileptus</em> had zero count/density per ml). Then we group the data by prey richness, prey composition, and replicate (prey richness is redundant but we want to keep it to work with later). Then we use <code>summarise</code> to get the maximum value of the <code>day</code> variable in the filtered data. Translated into R this looks like:</p>
<pre class="sourceCode r"><code class="sourceCode r">temp_persistence_time &lt;-<span class="st"> </span>dd <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(species <span class="op">==</span><span class="st"> &quot;Dileptus&quot;</span>, dens_per_ml <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_richness, prey_composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">last_day_observed =</span> <span class="kw">max</span>(day))</code></pre>
<p>Note that the created tibble has only 29 observations, whereas there were 35 experimental communities. This difference occurs because <em>Dileptus</em> was never observed in six of the experimental communities and so these are filtered out of this analysis. We will add them in below as a side effect of another manipulation, so don’t need to take care of this further here.</p>
<p>Next we need to recognise that the last day on which <em>Dileptus</em> was observed might have been the last day observed because it was after that observed to be extinct, or that it was never sampled again (e.g. if the last day observed was day 20). If we stop an experiment before we observe the event being watched for (e.g. before we observe extinction) then we say that the observation is <em>censored</em>.</p>
<p>We really should include this information in the persistence time dataset. To do so we need to get and add the day of last sample of <em>Dileptus</em>. We do this with the same pipeline as we used to get the last day observed, except we don’t exclude the observations when <em>Dileptus</em> was sampled and found to have zero abundance:</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_last_day &lt;-<span class="st"> </span>dd  <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(species<span class="op">==</span><span class="st">&quot;Dileptus&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(prey_richness, prey_composition, replicate) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">last_sample=</span><span class="kw">max</span>(day))</code></pre>
<p>The created tibble has the expected number of observations: 35.</p>
<p>We then join the two created tibbles and create a new variable that contains <code>TRUE</code> if the observation of persistence time was censored (indicated if the persistence time is the same as the last day sampled) or <code>FALSE</code> if a sample was taken after the observed persistence time (i.e. the observation is not censored).</p>
<pre class="sourceCode r"><code class="sourceCode r">pred_persistence_time &lt;-<span class="st"> </span><span class="kw">full_join</span>(temp_persistence_time, pred_last_day) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">censored=</span><span class="kw">ifelse</span>(last_day_observed<span class="op">==</span>last_sample, T, F))</code></pre>
<pre><code>## Joining, by = c(&quot;prey_richness&quot;, &quot;prey_composition&quot;, &quot;replicate&quot;)</code></pre>
<p>Because we used <code>full_join</code> we have 35 observations in the resulting tibble, with six <code>NA</code> values of persistence time (and also therefore <code>censored</code>) corresponding to the six communities that are missing from the <code>persistence_time</code> tibble because <em>Dileptus</em> was never observed in those communities.</p>
<div class="info">
<p>
<strong>Censored observations in time to event data</strong> Often we do not have the exact time at which the event of interest occurred. In this experiment we sampled only one every two days. If we observed some individuals on day 14, for example, and then none on or after day 16, we know that extinction occurred somewhere in the time interval between day 14 and day 16. Thus we have what is called “interval censored” time to event data. That is, unless extinction was not observed by the last sample, in which case the data are right censored, and we can only say that extinction (since it is at some point inevitable) will happen sometime after the day of the last sample. Censoring of time to event data is very common and is formally accounted for in statistical analyses of time to event type data. It certainly complicates and adds potential for misinterpreting visualisation of the data, so we must then at least differentiate data points by the type of censoring they have.
</p>
</div>
</div>
<div id="put-the-all-together" class="section level4">
<h4><span class="header-section-number">9.8.8.4</span> Put the all together</h4>
<p>Let’s put all three response variables into the same tibble, since it will make some of the subsequent things easier and more efficient. We want them all in the same column. “But wait”, you say! If all three response variables are in the same column/variable, how will we know which is which. Easy—we make another variable that tells us the response variable in each row. The new tibble will have 35 * 3 = 105 rows. There are lots of ways to do this. The approach we show is to merge/join the three tibbles containing each of the response variables (<code>pred_max_dens</code>, <code>pred_CV</code>, and <code>pred_persistence_time</code>) which creates a wide-formatted arrangement of the data (a different variable for each of the response variables). And then we’ll transform it into tidy (long) format by gather the information from each of the three separate response variables into one variable.</p>
<p>The first step is to merge all three tibbles:</p>
<pre class="sourceCode r"><code class="sourceCode r">spread_rr &lt;-<span class="st"> </span>pred_max_dens <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(pred_CV) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(pred_persistence_time)</code></pre>
<pre><code>## Joining, by = c(&quot;prey_richness&quot;, &quot;prey_composition&quot;, &quot;replicate&quot;, &quot;all_zero&quot;)</code></pre>
<pre><code>## Joining, by = c(&quot;prey_richness&quot;, &quot;prey_composition&quot;, &quot;replicate&quot;)</code></pre>
<p>We get told both joins are being done by <code>prey_richness</code>, <code>prey_composition</code>, and <code>replicate</code> and also <code>all_zero</code> for the first of the two joins. Lovely—thanks very much. (The join is done by these because R looks for variables shared by the two tibbles being joined, and by default joins by these.)</p>
<p>Next step is to gather the three response variables into one variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">rr &lt;-<span class="st"> </span>spread_rr <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;Response_type&quot;</span>, <span class="dt">value =</span> Value, max_dens, CV, last_day_observed)</code></pre>
<p>We tell <code>gather</code> that we’d like the values in the variables <code>max_dens</code>, <code>CV</code>, and <code>last_day_observed</code> gathered together an put into one variable called <code>Values</code> and that we’d like the <code>key</code> variable, i.e. the one that says which response variable each observation is about, to be named <code>Response_type</code>. If how <code>gather</code> works is unclear then please wait until Case Study 3, where the explanation goes into more depth, including a figure showing tidy/long data and the corresponding untidy/wide data (Figure <a href="8-6-acquire-import-check-the-fao-food-balance-sheet-data.html#fig:long-wide">7.1</a>).</p>
<p>Excellent. We now have a tibble <code>rr</code> with 105 observations (as expected), a variable named <code>Response_type</code> with entries <code>max_dens</code>, <code>CV</code>, and <code>last_day_observed</code>, and the values of each of these in the <code>Value</code> variable. We have the other variables <code>all_zero</code>, <code>last_sample</code>, and <code>censored</code> also (which is just fine).</p>
</div>
</div>
</div>
<p style="text-align: center;">
<a href="9-7-checking-the-import-worked-correctly.html"><button class="btn btn-default">Previous</button></a>
<a href="9-9-shapes-1.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
