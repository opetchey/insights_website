
#  What are the effects of dietary restriction? {#WFD-diet-restrict}


```{r message=FALSE, echo=TRUE, warning=FALSE}
## Load the libraries we use
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(lubridate)
library(skimr)
library(tidyr)
library(ggbeeswarm)
library(taxize)
library(broom)
library(forcats)
```

<img src="images/WF4_icon.jpg" width="60"/>


A general article about dietary restriction (DR): https://www.nia.nih.gov/health/calorie-restriction-and-fasting-diets-what-do-we-know

The case study article: *Reconciling nutritional geometry with classical dietary restriction: effects of nutrient intake, not calories, on survival and reproduction.* Moatt JP, Fyfe MA, Heap E, Mitchell LJM, Moon F, Walling CA (2018) Aging Cell, Volume 18, e12868.

Article: https://doi.org/10.1111/acel.12868

Data: https://doi.org/10.5061/dryad.g12p0j2

Abstract: "Here, using a novel nonmodel vertebrate system (the stickleback fish, *Gasterosteus aculeatus*), we test the effect of macronutrient versus calorie intake on key fitness‐related traits, both using the GF and avoiding dietary dilution. We find that the intake of macronutrients rather than calories determines both mortality risk and reproduction. Male mortality risk was lowest on intermediate lipid intakes, and female risk was generally reduced by low protein intakes. The effect of macronutrient intake on reproduction was similar between the sexes, with high protein intakes maximizing reproduction."

A discussion of these features of the case study data (put info in a box? A new type of box?):

The number of variables (columns) they contain.
The number of observations (rows).
If and how many of the variables describe experimental manipulations.
The amount of correlation among the variables.
How independent are the observations.

## Before working in R

**Question**: How does diet composition and amount of food individually and in combination affect individual characteristics related to health and fitness?

**Hypotheses/predictions**:

* Fitness: "mortality"
* Fitness: "reproductive behaviour (time spent courting)"
* Fitness: "Female reproduction (total egg production)"
* Health: "We use change in fish length as our measure of growth."
* Health: "As a proxy for overall health, we use body condition index, which is a measure of the weight of an individual relative to its length"

**Study methods and design** (**numbers of "things"**) "We fed 300 male and 300 female individually housed three‐spine sticklebacks one of five diets varying in protein and lipid content (Table 2) at one of three provisioning levels (100%, 75% or 50% of ad lib), therefore using a restriction of food availability rather than a dilution of the diets to achieve calorie restriction. This gave a total of 15 dietary treatments (see methods and supplementary materials for full details). Fish were maintained on diets for life and measured for numerous traits including survival, reproductive investment, growth and body condition. Given the broad range of traits examined, we present data for each trait separately, with an accompanying short interpretation section." 

"Mortality was checked twice daily and date of death was recorded. We quantified male lifetime reproductive investment as the total time spent courting (in seconds) across all courtship attempts. Males were also assayed for other common reproductive behaviours (e.g., territory defence, nesting and nuptial coloration—see supplementary methods and analysis). Female lifetime reproductive investment was taken as the total number of eggs produced). Fish were monitored for growth (length (mm) and weight (g)) approximately every 1–2 months (Supporting Information Table S26). From these measures, body condition (overall health) was also quantified (Moatt et al., 2017 and supplementary methods)."

Q: How many fish per treatment combination? A. 20

**Type of response variable:**

* Mortality---binary, dead or alive.
* Time spent courting---cannot be negative, will likely be numeric, may be distrete (e.g. 10 mins or 20 minutes) or continuous, ratio type.
* Female reproduction egg production---count type data, not negative, discrete (integers), ratio type.
* Change in fish length---could be negative or positive, ratio type.
* Body condition index (a measure of the weight of an individual relative to its length)-only positive, likely continuous, ratio type.

**Explanatory variables:**

* A variable about the diet composition treatment.
* A variable about the provisioning level treatment.
* Perhaps some others.

**Predictions**:
What were the predictions?


**Data birth**:

* **Number of variables**: not too many as a designed experiment with clear question.
* **Number of observations**: number of fish (they were "individually housed", and assigned treatment on an individual level).
* **Variables describing manipulations**: yes, two.
* **Correlation among variables**: low (factorial experiment, though some imbalance likely)
* **Independence of observations**: there may be multiple observations per fish (repeated measures). Fish may share mothers, fathers, and other pre-experiment conditions.


**Secure resources and perform study**




**Which datafiles:** Have a look at the data files on the dryad repository. Which data files are required for which response variable?

```{r}
mortality <- read_csv("data/Moatt_et_al_Data_S1.csv")
courtship <- read_csv("data/Moatt_et_al_Data_S5.csv")
eggs <- read_csv("data/Moatt_et_al_Data_S6.csv")
length_weight_condition <- read_csv("data/Moatt_et_al_Data_S15.csv")
```

**Variables in the datafiles**: Look at the `data file key` word document in the dryad repository.

Which variables tell us about the experimental design (including the explantory variables) and when observations were made?

* **FID** – Unique ID for each individual.
* **Diet** – Diet Treatment (Diet P:L: 1 = 10.2:1, 2 = 4.6:1, 3 = 2.5:1, 4 = 8.5:1, 5 = 1.6:1).
* **Sex** – Sex of individual (M = male, F = female).
* **Size** – Size classification of individual (L = large, S = Small).
* **Level** – Provisioning level, values represent percentages of monthly ad libitum monitoring.
* **Week_F** – Experimental week.
* **Batch** – Weighing batch.

There are numerous other variables in the datasets. We will look at them if and when we need to.

Which variables in which dataset can be used to calculate each of the five response variables?

* Mortality: `status`, 0 = alive, 1 = Dead, in `Moatt_et_al_Data_S1.csv`
* Time spent courting: `Total_court` – Total time courting across all trials, in `Moatt_et_al_Data_S5.csv`.
* Female reproduction egg production: `Total_egg` – Total number of eggs produced, in `Moatt_et_al_Data_S6.csv`.
* Change in fish length: Ln – Length of individual in mm, in `Moatt_et_al_Data_S15.csv`. 
* Body condition index: CI – Condition Index for each individual, `Moatt_et_al_Data_S15.csv`. 


**Number of rows and columns in the dataset**:
(By looking at the datasets in a spreadsheet programme)

* `Moatt_et_al_Data_S1.csv`:  33'049 rows, 24 variables
* `Moatt_et_al_Data_S5.csv`: 228, 16
* `Moatt_et_al_Data_S6.csv`: 269, 14
* `Moatt_et_al_Data_S15.csv`:6000, 18

## After importing the data into R

* number of rows and columns: as expected
* tidy: all four datasets appear tidy, at the moment.
* variable types: all as expected
* fix dates: none present

**Make more informative variable names (and discard variables not obviously of use)**:

```{r}
courtship <- courtship %>%
  select(Fish_ID=FID, Family, Shelf_stack, Diet_comp=Diet,
         Prov_level=Level, Fish_size=Size, Trial, Total_court)
eggs <- eggs %>%
  select(Fish_ID=FID, Family, Shelf_stack=Stack_shelf, Diet_comp=Diet,
         Prov_level=Level, Fish_size=Size, Total_egg)
length_weight_condition <- length_weight_condition %>%
  select(Fish_ID=FID, Shelf_stack, Diet_comp=Diet, Sex=Sex,
         Batch,
         Prov_level=Level, Fish_size=Size, Length=Ln, Weigth=Wt, Cond_index=CI)
mortality <- mortality %>%
  select(Fish_ID=FID, Diet_comp=Diet, Sex,
         Prov_level=Level, Fish_size=Size, Week=Week_F, Status)
```


**Replace codes with informative words**:

```{r}
courtship <- courtship %>%
  mutate(Diet_comp = case_when(Diet_comp == 1 ~ "10.2:1",
                               Diet_comp == 2 ~ "4.6:1",
                               Diet_comp == 3 ~ "2.5:1",
                               Diet_comp == 4 ~ "8.5:1",
                               Diet_comp == 5 ~ "1.6:1"),
         Fish_size = case_when(Fish_size == "S" ~ "Small",
                               Fish_size == "L" ~ "Large"))

eggs <- eggs %>%
  mutate(Diet_comp = case_when(Diet_comp == 1 ~ "10.2:1",
                               Diet_comp == 2 ~ "4.6:1",
                               Diet_comp == 3 ~ "2.5:1",
                               Diet_comp == 4 ~ "8.5:1",
                               Diet_comp == 5 ~ "1.6:1"),
         Fish_size = case_when(Fish_size == "S" ~ "Small",
                               Fish_size == "L" ~ "Large"))

length_weight_condition <- length_weight_condition %>%
  mutate(Diet_comp = case_when(Diet_comp == 1 ~ "10.2:1",
                               Diet_comp == 2 ~ "4.6:1",
                               Diet_comp == 3 ~ "2.5:1",
                               Diet_comp == 4 ~ "8.5:1",
                               Diet_comp == 5 ~ "1.6:1"),
         Fish_size = case_when(Fish_size == "S" ~ "Small",
                               Fish_size == "L" ~ "Large"),
         Sex = case_when(Sex == "M" ~ "Male",
                         Sex == "F" ~ "Female"))

mortality <- mortality %>%
  mutate(Diet_comp = case_when(Diet_comp == 1 ~ "10.2:1",
                               Diet_comp == 2 ~ "4.6:1",
                               Diet_comp == 3 ~ "2.5:1",
                               Diet_comp == 4 ~ "8.5:1",
                               Diet_comp == 5 ~ "1.6:1"),
         Fish_size = case_when(Fish_size == "S" ~ "Small",
                               Fish_size == "L" ~ "Large"),
         Sex = case_when(Sex == "M" ~ "Male",
                         Sex == "F" ~ "Female"),
         Status = case_when(Status == 0 ~ "alive",
                            Status == 1 ~ "dead"))

```

### Checking for duplicates

Question: which of the four datasets contains an odd duplicate entry? And which fish is involved? What should we do next?

```{r}
sum(duplicated(select(courtship, Fish_ID)))
sum(duplicated(select(eggs, Fish_ID)))
sum(duplicated(select(length_weight_condition, Fish_ID, Batch)))
sum(duplicated(select(mortality, Fish_ID, Week)))
dupl <- duplicated(select(mortality, Fish_ID, Week))
filter(mortality, dupl)
filter(mortality, Fish_ID=="LR504", Week==2)
filter(mortality, Fish_ID=="LR504")
```

### NAs, variable entries, e.g. levels of characters, ranges of numerics, numbers of "things"*

How many missing values in the courtship dataset (remember to reduce the variables to those mentioned above)?

Which variable(s) contain missing values?

Which fish have missing values?

How many different entries are there in the `Shelf_stack` variable?

What are the mean and median of the `Total_court` variable?

What are the units of the `Total_court` variable? (From paper only, seconds)


```{r}
skim(courtship)
filter(courtship, is.na(Total_court))
```
228 fish IDs

```{r}
skim(eggs)
filter(eggs, is.na(Total_egg))
```
269 fish IDs

```{r}
skim(length_weight_condition)
```
600 fish IDs

```{r}
skim(mortality)
```
594 fish IDs

## Independence

```{r}
table(pull(courtship, Fish_ID))
table(pull(eggs, Fish_ID))
table(pull(length_weight_condition, Fish_ID))
table(pull(mortality, Fish_ID))
```


## Balance in experimental design

```{r}
temp <- courtship %>%
  group_by(Diet_comp, Prov_level) %>%
  summarise(count=n(),
            n_unique=length(unique(Fish_ID)))
sum(pull(temp, n_unique))
```
228 Fish_IDs is what we found already for this dataset.

```{r}
temp <- eggs %>%
  group_by(Diet_comp, Prov_level) %>%
  summarise(n(),
            n_unique=length(unique(Fish_ID)))
sum(pull(temp, n_unique))
```
269 Fish_IDs is what we found already for this dataset.
WHY??? 21 for 2.5:1  100    21       21
Check below.

```{r}
egg_ids <- unique(pull(eggs, Fish_ID))
courtship_ids <- unique(pull(courtship, Fish_ID))
length(unique(c(egg_ids, courtship_ids)))
```


```{r}
length_weight_condition %>%
  group_by(Diet_comp, Prov_level) %>%
  summarise(n(),
            n_unique=length(unique(Fish_ID)))
length(unique(pull(length_weight_condition, Fish_ID)))
```
40 of each, hence 600 fish IDs

```{r}
mortality %>%
  group_by(Diet_comp, Prov_level) %>%
  summarise(n(),
            n_unique=length(unique(Fish_ID)))
```
39 or 40 of each (six of 39, hence 594 fish IDs)

## Calculate response variable(s) (if required)

The courtship and eggs datasets already contain the response variable.
We need to calculate the response variable for the change in fish length and change in body condition from the `length_weight_condition` dataset, and the time of death (or no death [censored]) from the `mortality` dataset.


### Time of death

```{r}
temp_mortality2 <- mortality %>%
  filter(Status=="alive") %>%
  group_by(Fish_ID, Diet_comp, Prov_level, Sex) %>%
  summarise(Lifespan=max(Week))
last_obs <- mortality  %>%
  group_by(Fish_ID, Diet_comp, Prov_level) %>%
  summarise(Last_sample=max(Week))
mortality2 <- full_join(temp_mortality2, last_obs) %>%
  mutate(Censored=ifelse(Lifespan==Last_sample, T, F),
         Lifespan=ifelse(is.na(Lifespan), 0, Lifespan),
         Censored=ifelse(Lifespan==0, FALSE, Censored)) %>%
  ungroup() %>%
  select(-Last_sample)
skim(mortality2)
```

Above, we set the eight fish that were already dead at week 1 as having a lifespan of zero.

### Change in length


```{r}
change1 <- length_weight_condition %>%
  group_by(Fish_ID, Diet_comp, Prov_level) %>%
  do(m1 = lm(Length ~ Batch, data=.)) %>%
  tidy(m1) %>%
  filter(term=="Batch") %>%
  select(Fish_ID, Diet_comp, Prov_level, Length_change=estimate)
```

Note that `tidy` silently drops NA coefficients.

### Change in condition

Not quite what they did in the paper. But...

```{r}
change2 <- length_weight_condition %>%
  group_by(Fish_ID, Diet_comp, Prov_level) %>%
  do(m1 = lm(Cond_index ~ Batch, data=.)) %>%
  tidy(m1) %>%
  filter(term=="Batch") %>%
  select(Fish_ID, Diet_comp, Prov_level, CI_change=estimate)
```

Note that `tidy` silently drops NA coefficients.

## Merge all datasets together and check for correct number of rows

```{r}
dd <- full_join(courtship, eggs) %>%
  full_join(mortality2) %>%
  full_join(change1) %>%
  full_join(change2)
```

Bring in and merge the diet comp data
```{r}
diet_comp <- read_csv("data/diet_comp_treatments.csv")
dd <- full_join(dd, diet_comp)
```


```{r}
dd <- mutate(dd,
             Diet_comp = fct_relevel(Diet_comp,
                                            "1.6:1",
                                            "2.5:1",
                                            "4.6:1",
                                            "8.5:1",
                                            "10.2:1"),
             Prov_level = fct_relevel(as.character(Prov_level),
                                            "50",
                                            "75",
                                            "100"))

```

## Super sleuth questions

About:

* Two females doing courtship, perhaps odd?
* Some males laying eggs... a bit strange.



## Inspect shapes (distributions)

```{r}
ggplot(dd, aes(x=Total_court)) +
  geom_histogram()
ggplot(dd, aes(x=Total_egg)) +
  geom_histogram()
ggplot(dd, aes(x=Lifespan)) +
  geom_histogram()
ggplot(dd, aes(x=Length_change)) +
  geom_histogram()
ggplot(dd, aes(x=CI_change)) +
  geom_histogram()

dd <- dd %>%
  mutate(period=cut(Lifespan, breaks=c(-1, 20, 60, 106, 120)))
```



## Inspect relationships

"Male mortality risk was lowest on intermediate lipid intakes".

```{r}
dd %>% filter(Sex=="Male") %>%
ggplot(aes(x=Lipid, y=Lifespan, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.05)) +
  facet_wrap(~period, nrow=3)
```

"Female risk was generally reduced by low protein intakes."

```{r}
dd %>% filter(Sex=="Female") %>%
ggplot(aes(x=Protein, y=Lifespan, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.05)) +
  facet_wrap(~period, nrow=3)
```

"The effect of macronutrient intake on reproduction was similar between the sexes, with high protein intakes maximizing reproduction."

```{r}
dd %>% filter(Sex=="Male") %>%
ggplot(aes(x=Protein, y=Total_court, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.05))
dd %>% filter(Sex=="Female") %>%
ggplot(aes(x=Protein, y=Total_court, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.05))

```

```{r}
dd %>% filter(Sex=="Male") %>%
ggplot(aes(x=Protein, y=Total_egg, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.05))
dd %>% filter(Sex=="Female") %>%
ggplot(aes(x=Protein, y=Total_egg, col=Prov_level)) +
  geom_point(position = position_jitterdodge(jitter.width=0.2, dodge.width = 5))

```





## Moatt et al Data S1 – Mortality Data

* FID – Unique ID for each individual.
* Diet – Diet Treatment (Diet P:L: 1 = 10.2:1, 2 = 4.6:1, 3 = 2.5:1, 4 = 8.5:1, 5 = 1.6:1).
* Sex – Sex of individual (M = male, F = female).
* Size – Size classification of individual (L = large, S = Small).
* Level – Provisioning level, values represent percentages of monthly ad libitum monitoring.
* Total_eaten – Total pellet eaten in g from the start of the experiment.
* Eaten_wk – Amount of pellet consumed that week (gweek-1).
* P_tot - Total protein eaten in g from the start of the experiment.
* P2_total – P_tot2 squared (i.e. the total protein eaten squared). 
* P_wk – Amount of protein consumed that week (gweek-1).
* P2_wk – P_wk2 squared (i.e. the weekly protein intake squared).
* L_tot - Total lipid eaten in g from the start of the experiment.
* L2_total – L_tot2 squared (i.e. the total lipid eaten squared). 
* L_wk – Amount of lipid consumed that week (gweek-1).
* L2_wk – L_wk2 squared (i.e. the weekly lipid intake squared).
* Weight – Weight of fish from last weighing (g).
* Week_F – Experimental week.
* Status – Survival status (0= alive, 1 = Dead).
* T_group – Time period of the experiment (see Fig. S1).
* Initial_weight – Initial weight of individual at the start of the experiment.
* ZP – P_wk z transformed (mean of 0 and standard deviation of 1).
* ZP2 – P2_wk z transformed (mean of 0 and standard deviation of 1).
* ZL – L_wk z transformed (mean of 0 and standard deviation of 1).
* ZL2 – L2_wk z transformed (mean of 0 and standard deviation of 1).

## Moatt et al Data S5 – Courtship Data

* FID – Unique ID for each individual.
* Family – Unique code for family group (i.e. clutch of origin). Each clutch produced from a unique sire and dam.
* Shelf_stack – Unique code for the stack and shelf of fish home tank.
* Diet – Diet Treatment (Diet P:L: 1 = 10.2:1, 2 = 4.6:1, 3 = 2.5:1, 4 = 8.5:1, 5 = 1.6:1).
* Level – Provisioning level, values represent percentages of monthly ad libitum monitoring.
* Size – Size classification of individual (L = large, S = Small).
* Trial – Number of trials that individual experienced.
* Days_breeding – Length of breeding season for that individual.
* P_day – Average protein intake per day during the breeding season (gday-1).
* P2_day – P_day2 squared (i.e. daily protein intake squared).
* L_day - Average lipid intake per day during the breeding season (gday-1).
* L2_day – L_day2 squared (i.e. daily lipid intake squared).
* Mean_react – Mean reaction time across all trials for that individual.
* Total_ZZ – Total number of zigzags across all trials.
* Total_leads – Total number of leads across all trials.
* Total_court – Total time courting across all trials.

## Moatt et al Data S6 – Eggs Data

* FID – Unique ID for each individual.
* Family – Unique code for family group (i.e. clutch of origin). Each clutch produced from a unique sire and dam.
* Shelf_stack – Unique code for the stack and shelf of fish home tank.
* Diet – Diet Treatment (Diet P:L: 1 = 10.2:1, 2 = 4.6:1, 3 = 2.5:1, 4 = 8.5:1, 5 = 1.6:1).
* Level – Provisioning level, values represent percentages of monthly ad libitum monitoring.
* Size – Size classification of individual (L = large, S = Small).
* P_day – Average protein intake per day during the breeding season (gday-1).
* P2_day – P_day2 squared (i.e. daily protein intake squared).
* L_day - Average lipid intake per day during the breeding season (gday-1).
* L2_day – L_day2 squared (i.e. daily lipid intake squared).
* Days_breeding – Length of breeding season for that individual.
* Number_clutches – Number of clutches produced by that individual.
* Mean_number – Mean number of eggs per clutch.
* Total_egg – Total number of eggs produced.

## Moatt et al Data S15 – Length, Weight and Condition Index Data

* FID – Unique ID for each individual.
* StackShelf – Unique code for the stack and shelf of fish home tank.
* Sex – Sex of individual (M = male, F = female).
* Diet – Diet Treatment (Diet P:L: 1 = 10.2:1, 2 = 4.6:1, 3 = 2.5:1, 4 = 8.5:1, 5 = 1.6:1).
* Level – Provisioning level, values represent percentages of monthly ad libitum monitoring.
* Size – Size classification of individual (L = large, S = Small).
* Batch – Weighing batch. NB Batch 1 is prior to diet treatments therefore has no corresponding values for protein and lipid intake.
* P_day – Average protein intake per day during the breeding season (gday-1).
* P2_day – P_day2 squared (i.e. daily protein intake squared).
* L_day - Average lipid intake per day during the breeding season (gday-1).
* L2_day – L_day2 squared (i.e. daily lipid intake squared).
* ZP – Daily protein intake z transformed (mean of 0 and standard deviation of 1), calculated for each sex independently.
* ZP2 – Daily protein intake squared, z transformed (mean of 0 and standard deviation of 1), calculated for each sex independently.
* ZL – Daily lipid intake z transformed (mean of 0 and standard deviation of 1), calculated for each sex independently.
* ZL2 – Daily lipid intake squared, z transformed (mean of 0 and standard deviation of 1), calculated for each sex independently.
* Ln – Length of individual in mm.
* Wt – Weight of individual in g.
* CI – Condition Index for each individual. 

