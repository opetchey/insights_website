---
title: "Insights online"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE, message=FALSE}
library(learnr)
library(dplyr)
library(ggplot2)
library(readr)
library(stringr)
library(lubridate)
library(skimr)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE)
```


```{r message=FALSE, warning=FALSE}
dd <- read_csv("www/data/bat_sex_diet_Mata_etal_2016.csv", na="na")
names(dd) <- str_replace_all(names(dd), c(" " = "_"))
names(dd) <- str_replace_all(names(dd), c("\\(" = "", "\\)" = ""))
dd <- mutate(dd,
             Date_proper=dmy(Date),
             Sex=case_when(Sex=="M" ~ "Male",
                           Sex=="F" ~ "Female"),
             Age=case_when(Age=="Ad" ~ "Adult",
                           Age=="Juv" ~ "Juvenile")) %>%
#  select(-Date) %>% # commented out so we can demo a non-date variable
  rename("Bat_ID" = "Sample")
```


## Introduction to this website

...


## Preface

The preface of *Insights* informs about features of the book, such as its aims, content, structure, intended readership, and content that it does not include. Some of the text in the Preface may come across as a sales pitch (it probably is), but it also aims to make prospective readers clear about what they will find in *Insights* and why. The following questions, directly concerning the content of the Preface, might also help that understanding.



```{r preface-1, echo=FALSE}
question("Who is the intended audience/users/readers of *Insights*? (**Select all that apply.**)",
  answer("People who have a need to efficiently, safely, and reliably derive robust insights from quantitative data.", correct = TRUE, message = ""),
  answer("People with a good knowledge of working with data and data analysis, but not in R.", correct = FALSE, message = "If you already have good knowledge of data analysis and statistics and need an introduction to R, you might like to look at our other book, Getting Started with R, 2nd Edition (link below)."),
  answer("Instructors/teachers of undergraduate's first courses in data analysis, in particular in Life and Environmental Sciences.", correct = TRUE, message = ""),
  answer("People who will benefit from a learning approach that gives confidence in their ability to succeed.", correct = TRUE, message = ""),
  correct = "Correct. *Insights* is intended for beginner scientists in the life and environmental scientist that will be working with quantitative data. Our other book, *Getting Started with R* is for folk that what an introduction to R and who already know a bit about data analysis (just not in R).",
  incorrect = "Incorrect.",
  allow_retry = TRUE,
  random_answer_order = TRUE
)
```

[Link to *Getting Started with R*, Second Edition.](http://r4all.org/books/gswr2/)

```{r preface-2, echo=FALSE}
question("*Insights* teaches a “modern” approach to using R, and not what might be called the “classic” or “traditional” approach. What does this mean? (**Select all that apply.**)",
  answer("Learning based on the “tidyverse” packages that have revolutionised data exploration and analysis in R", correct = TRUE, message = ""),
  answer("A more consistent and therefore easily taught and learned approach.", correct = TRUE, message = ""),
  answer("A lot of use of square brackets and dollar signs in the R code.", correct = FALSE, message = "No. The modern approach thankfully dispenses with such things."),
  answer("It allows us to very easily construct powerful, efficient, easy to troubleshoot, and just plain lovely *pipelines* that work on our data.", correct = TRUE, message = ""),
  answer("Simple, powerful, flexible, and beautiful data visualisations (graphs).", correct = TRUE, message = ""),
  correct = "Correct. We teach the modern approach in our own Undergraduate-Level Introduction to Data Analysis courses. It works really well. The modern approach is not advanced-R, it is simple, intuitive, and powerful R.",
  incorrect = "Incorrect. Please try again. Hint: *Insights* contains not a single square bracket or dollar sign.",
  allow_retry = TRUE,
  random_answer_order = TRUE
)
```


```{r preface-3, echo=FALSE}
question("*Insights* is a book about the process of getting insights from data, and yet it contains no statistical analyses (e.g. no regression, ANOVA, linear models, or generalised linear models. Why are such things not included? (**Select all that apply.**)",
  answer("There is enough to be learned about data analysis and to be gained from data analysis without such tests. The skills covered in *Insights* are essential. Statistical tests should only be used to confirm what we see with our own eyes.", correct = TRUE, message = ""),
  answer("Statistical tests can be quite daunting and difficult, so we leave them until we have a solid hold on more foundational skills in data analysis.", correct = TRUE, message = ""),
  answer("Not including statistical tests eliminates the risk that early learning of statistical tests encourages a rather one dimensional view of data analysis focused on statistical significance and p-values.", correct = TRUE, message = ""),
  answer("Avoiding statistics encourages us to pay more attention to the practical significance (as opposed to statistical significance.", correct = TRUE, message = ""),
  correct = "Yes, all these are good reasons for starting learning about data analysis without considering statistics.",
  incorrect = "Incorrect. Please try again.",
  allow_retry = TRUE,
  random_answer_order = TRUE
)
```

```{r preface-4, echo=FALSE}
message_wrong <- "We wish data were alway so nicely prepared that such little time and effort were required, but in reality we usually spend much more time and effort on just getting the data ready."
question("What proportion of a data analyists time and effort is spent on tasks such as preparation, import, cleaning, tidying, checking, double-checking, manipulating, summarising and visualizating data?",
  answer("50", message = message_wrong),
  answer("20", message = message_wrong),
  answer("80", correct = TRUE, message = "Yes, around 80%, though really it just means *a lot*. Care and attention to this work is essential to provide a found foundation dataset from which to derive insights."),
  answer("5", , message = message_wrong),
  allow_retry = TRUE,
  random_answer_order = TRUE
)
```

```{r preface-5, echo=FALSE}
question("From where do you get most of the datasets that you need to work along with the case studies in the book?",
  answer("E-mail one of the authors", message = "We love to hear from you, and will send you the datasets, but it will be much much faster for you to get them yourself. Look at the *Datasets* link on the left of this page."),
  answer("From this website", message = "You can get a couple of them here, yes, but the core ones you get from online repositories."),
  answer("From the authors of the original sudies the data is from", message = "Please do not do this, otherwise we will get in lots of trouble."),
  answer("From online data repositories where the authors of the original studies deposited their data for it to be shared and used.", correct = TRUE, message = ""),
  correct = "Yes. Unlike the majority of Introduction to Data Analysis books, *Insights* starts from the usual dirty and messy state data usual begins in. Its lot of work, but absolutely essential work to do safely and reliably, to get the data tidy, clean, and arranged so that visualisation and summarisation (and in the end, statistics) are straightforward and efficient, and that the insights derived from them are accurate, reliable, and robust.",
  allow_retry = TRUE,
  random_answer_order = TRUE
)
```

Some questions about the authors:

```{r quiz}
quiz(
  question("Which one works at the Natural History Museum in London?",
    answer("Owen"),
    answer("Andrew"),
    answer("Natalie", correct = TRUE),
    answer("Dylan")
  ),
  question("Which one brews beer?",
    answer("Owen", correct = TRUE),
    answer("Andrew"),
    answer("Natalie"),
    answer("Dylan")
  ),
  question("Which is American?",
    answer("Owen"),
    answer("Andrew", correct = TRUE),
    answer("Natalie"),
    answer("Dylan")
  ),
  question("Which are losing their hair?",
    answer("Owen", correct = TRUE),
    answer("Andrew"),
    answer("Natalie"),
    answer("Dylan", correct = TRUE)
  )
)
```



## Chapter 1, what is data, what are insights?

Exercise with Hint

*Here's an exercise where the chunk is pre-evaulated via the `exercise.eval` option (so the user can see the default output we'd like them to customize). We also add a "hint" to the correct solution via the chunk immediate below labeled `print-limit-hint`.*

Modify the following code to limit the number of rows printed to 5:

```{r print-limit, exercise=TRUE, exercise.eval=TRUE}
mtcars
```

```{r print-limit-hint}
head(mtcars)
```

Quiz

*You can include any number of single or multiple choice questions as a quiz. Use the `question` function to define a question and the `quiz` function for grouping multiple questions together.*



## Chapter 2, getting acquainted

Give an R script with errors for correction.




## Chapter 3, CS1, part 1

### Easy


### Medium


### Difficult



**Question 3.1** The Abstract states that Lepidoptera were mostly from the Noctuidae and Geometridae familes. How many species of Noctuidae and Geometridae are there in the dataset?

```{r}
## Solution
fams <- dd %>%
  select(Species, Order_1, Family) %>%
  distinct() %>%
  group_by(Order_1, Family) %>%
  summarize(num_spp=n())
```

**Question 3.1** How to get *56.9±36.7% were migratory moth species*.

```{r}
dd %>%
  group_by(Bat_ID, Migratory) %>%
  summarise(num_prey=n()) %>%
  spread(key=Migratory, value=num_prey) %>%
  mutate(no=ifelse(is.na(no), 0, no),
         yes=ifelse(is.na(yes), 0, yes),
         perc_migratory=yes/(yes+no)) %>%
  ungroup() %>%
  summarise(mean(perc_migratory),
            sd(perc_migratory))

```

**Question 3.1** How many of the prey species are classed as pests, and does it look like the proportion of pest species in diets differs by sex and age of the bat?

```{r}
## Solution
```


**Question 3.1** Confirm the results from the paper: *Moths (Lepidoptera; mainly Noctuidae and Geometridae) were by far the most frequently recorded prey, occurring in nearly all samples and accounting for 96 out of 115 prey taxa.*

```{r}
dd %>%
  select(Species, Order_1) %>%
  distinct() %>%
  group_by(Order_1) %>%
  summarize(num_spp=n())
```

**Question 3.1** Confirm the results from the paper: *Each pellet contained on average 4.1 ± 2.2 prey items*

```{r}
dd %>%
  group_by(Bat_ID) %>%
  summarise(num_prey=n()) %>%
  summarise(mean(num_prey),
            sd(num_prey))


```

Not sure why the value is a bit different! 


**Question 3.1** select helper function question

```{r}
## Solution
```

**Question 3.1** Which variable in the bat diet dataset is numeric but should not be?

A. `Bat_ID` is numeric, but these are identities (i.e. names). They could just as well be words. Leaving them as numbers could allow us to do something stupid, like involving them in a calculation. Using numbers in such situation can also result in `ggplot` not doing what we'd like, for example would lead to a colour gradient rather than discrete colours if we mapped the numerical variable to the colour aesthetic.
```{r}
```


## Chapter 4, Key-R



## Chapter 5, Key-Concepts



## Chapter 6, CS1, part 2

Give an R script of analysis with errors for correction.

**Question 6.1** The Abstract states that Lepidoptera were mostly from the Noctuidae and Geometridae familes. How many species of Noctuidae and Geometridae are there in the dataset?

```{r}
## Solution
fams <- dd %>%
  select(Species, Order_1, Family) %>%
  distinct() %>%
  group_by(Order_1, Family) %>%
  summarize(num_spp=n())
```

**Question 6.1** How to get *56.9±36.7% were migratory moth species*.

```{r}
dd %>%
  group_by(Bat_ID, Migratory) %>%
  summarise(num_prey=n()) %>%
  spread(key=Migratory, value=num_prey) %>%
  mutate(no=ifelse(is.na(no), 0, no),
         yes=ifelse(is.na(yes), 0, yes),
         perc_migratory=yes/(yes+no)) %>%
  ungroup() %>%
  summarise(mean(perc_migratory),
            sd(perc_migratory))

```

**Question 6.1** How many of the prey species are classed as pests, and does it look like the proportion of pest species in diets differs by sex and age of the bat?

```{r}
## Solution
```


## Chapter 7, CS2

???Give an R script of analysis with errors for correction.



**Question 7.1** What would be get if we used `inner_join` to merge the `temp_persistence_time` and `max_day` tibbles? Specifically, how many observations/rows would we expect in the merged tibble. You should be able to work this out without using R, but go ahead and check with R after you do so.

**Answer 7.1** There will be 29 rows because `inner_join` only keeps records that occur in both of the source datasets. There are only 29 rows in the `temp_persistence_time` tibble because *Dileptus* was never observed in six of the experimental communities. Only these 29 observations occur in both of the source datsets. Check this in R with:

```{r eval=FALSE}
persistence_time <- inner_join(temp_persistence_time, pred_last_day)
nrow(persistence_time)
```



## Chapter 8, CS3

Give an R script of analysis with errors for correction.


**Question 8.1**

Insert question

```{r}
## Solution
```

### Difficult

Check to see if GDP or GDP per capita can explain variation in dietary diversity? What, if anything, would you imagine is the causation among political system, GDP, and dietary diversity (you might use the data to try to infer this, or just think about it)?

Get the GDP data from here: http://www.fao.org/faostat/en/#data/MK 

```{r}
gdp <- read_csv("~/Desktop/Macro-Statistics_Key_Indicators_E_All_Data.csv",
               locale = locale(encoding = 'ISO-8859-1'))
## First fix some variable names:
names(gdp) <- str_replace_all(names(gdp), c(" " = "_"))
## Remove all non-countries
## keep only some of the elements
#gdp <-   filter(gdp, Item_Code==22008 & Element_Code==6110)
gdp <-   filter(gdp, Item_Code==22014 & Element_Code==6119)
gdp <- select(gdp, -Item_Code, -Area_Code,
             -Element_Code, -Element, -Unit, -Item,
             -ends_with("F")) %>%
  gather(key=Year, value=GDP, 2:48) %>%
  mutate(Year=as.numeric(substr(Year, 2, 5))) %>%
  rename(Country=Area)
dd_all <- full_join(dd, gdp)

dd_sum <- group_by(dd_all, Country) %>%
  summarise(mean_div=mean(diversity, na.rm=TRUE),
            mean_pol=mean(Polity2, na.rm=TRUE),
            mean_GDP=mean(GDP, na.rm=TRUE))

ggplot(dd_sum, aes(x=log10(mean_GDP), y=mean_div, col=mean_pol)) +
  geom_point(size=3)

ggplot(dd_sum, aes(x=mean_pol, y=mean_div, col=log10(mean_GDP))) +
  geom_point(size=3)

ggplot(dd_sum, aes(x=mean_pol, y=log10(mean_GDP), col=mean_div)) +
  geom_point(size=3)


```



## Chapter 9, key concepts arising


## Chapter 10, looking back and forward


## An extra case study

As well as the additional suggested [case studies on the R4All website](link) here is a walkthrough a new one:

